#!/usr/bin/env python3
"""process entire docs directory to adapt varnomen pages to mkdocs"""

import pathlib
import re
import sys


def process1(content: str) -> str:
    # move title from header to # heading
    m = re.search(r"title:\s+([^\n]+)", content)
    try:
        title = m.group(1)
        content = re.sub(r'# \{\{\s*page.title\s*\}\}', "# " + title, content)
    except AttributeError:
        pass
    
    # simple string replacements
    content = content.replace('{:target="\_blank"}', "")   
    content = content.replace("{:#version-list}", "")
    content = content.replace("/bg-material/", "/background/")

    # remove header
    content = re.sub(r"^---.+---\s+(?=#)", "", content, flags=re.S)
    
    # remove separators
    content = re.sub(r"^\* \* \*\s*$", "", content, flags=re.MULTILINE)
    
    # standardize case of SVD-WG references (all uppercase), including filenames
    content = re.sub(r"svd-wg(\d+)", r"SVD-WG\1", content)
    
    # HVNC.md table
    content = content.replace("{:.table .table-bordered}", "")
    content = content.replace("|:--------------------------------------:|:-------------:|", "|:--------------------------------------|:-------------:|") 
    content = re.sub(r"\|\s+\|\s+\|\n", r"", content, re.MULTILINE)

    # TODO:
    # - ### **...** â†’ drop emphasis
    # lint/reformat?

    return content


for path in sys.argv[1:]:
    content = open(path, "rt").read()
    content = process1(content)
    open(path, "wt").write(content)