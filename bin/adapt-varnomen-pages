#!/usr/bin/env python3
"""process entire docs directory to adapt varnomen pages to mkdocs"""

import pathlib
import re
import sys

_ = """
TODO:
- {:#DNAo}
"""



def process1(content: str) -> str:
    # move title from header to # heading
    m = re.search(r"title:\s+([^\n]+)", content)
    try:
        title = m.group(1)
        content = re.sub(r'# \{\{\s*page.title\s*\}\}', "# " + title, content)
    except AttributeError:
        pass
    
    # simple string replacements
    content = content.replace('{:target="\_blank"}', "")
    content = content.replace('{:target="blank"}', "")
    content = content.replace("{:#version-list}", "")
    content = content.replace("/bg-material/", "/background/")

    # remove header
    content = re.sub(r"^---.+---\s+(?=#)", "", content, flags=re.S)
    
    # `### **...**`` â†’ drop emphasis
    content = re.sub(r"^(#+)\s+\*\*(.+?)\*\*", r"\1 \2", content, flags=re.MULTILINE)

    # remove separators
    content = re.sub(r"^\* \* \*\s*$", "", content, flags=re.MULTILINE)
    
    # standardize case of SVD-WG references (all uppercase), including filenames
    content = re.sub(r"svd-wg(\d+)", r"SVD-WG\1", content)

    # replace FF0000 with bold
    content = re.sub(r'<font color="#FF0000">(.+?)</font>', r"**\1**", content)

    # remove overstyling
    content = re.sub(r"_\*\*(.+?)\*\*_", r"**\1**", content)
    content = re.sub(r"\*\*_(.+?)_\*\*", r"**\1**", content)

    # table reformatting    
    content = content.replace("{:.table .table-bordered}", "")
    content = re.sub(r"\n\s*\|(\s+\|)+\n", r"\n", content)
    content = content.replace("|:--------------------------------------:|:-------------:|", "|:--------------------------------------|:-------------:|") 

    # remove spaces around list markers, replace tabs with space, remove eol space
    content = re.sub(r"^(\s*\*)\s+", r"\1 ", content, flags=re.MULTILINE)
    content = re.sub(r"\t", r"    ", content, flags=re.MULTILINE)
    content = re.sub(r"\s+$", r"", content)

    # image paths refer to the baseurl, which is no longer needed   
    content = content.replace("{{site.baseurl}}", "")
    content = content.replace("{:.img-responsive .center-block #refSeqFig}", "")
 
    # pull definitions up with preceeding line
    content = re.sub(r"\n\s+:\s+", r": ", content)
 
    # remove extraneous newlines
    content = re.sub(r"\n\n+", r"\n\n", content)
 
    return content


def process_recommendations(content: str) -> str:
    content = re.sub(r"### (Call for members)\n\n(.+?)\n\n", r'!!! note "\1"\n\n    \2\n\n', content)
    return content


def process_bugs(content: str) -> str:
    content = content.replace("Fig.1D]((http:", "Fig.1D](http:")
    return content

for path in sys.argv[1:]:
    content = open(path, "rt").read()
    content = process1(content)
    content = process_bugs(content)
    if path.endswith("/HVNC.md"):
        content = process_recommendations(content)
    open(path, "wt").write(content)